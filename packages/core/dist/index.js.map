{"version":3,"sources":["../src/index.ts","../src/regexps.ts","../src/generator.ts","../src/compiler.ts","../src/context.ts","../src/utils.ts"],"sourcesContent":["import { createContext } from \"./context\"\nimport { PluginOption } from 'vite'\nimport { filterVue } from \"./utils\"\nimport type { MiniunocssParams } from './types'\n\nexport function miniunocss({ presets }: MiniunocssParams) {\n  const context = createContext(presets)\n  return {\n    name: 'miniunocss',\n    enforce: 'pre',\n    transform(code, id) {\n      if (!filterVue(id)) return\n      context.parseCode(code)\n      return null\n    }\n  } as PluginOption\n}\n\n","export const classReg = /class=[\\\"|\\'](.+?)[\\\"|\\']/g;\n","import { Context } from \"./context\";\nimport { Vunocss } from \"./types\";\n\nexport class CssGenerator {\n  constructor(public _ctx: Context) {\n  }\n  generateCss() {\n    const ctx = this._ctx\n    let css = ''\n    ctx._vunocss.forEach(vunocss => {\n      if (vunocss.flag === 'pseudo') {\n        css += this.generatePseudo(vunocss)\n        \n      } else if (vunocss.flag === 'class') {\n        // console.log(11);\n        // console.log({vunocss});\n        css += this.generateString(vunocss)\n      }\n    })\n    console.log(css);\n    \n    this._ctx.reset()\n  }\n  generateString(vunocss: Vunocss) {\n    const {className} = vunocss\n    const attrStr = this.generateAttrs(vunocss)\n    return `.${className}{${attrStr}}`\n  }\n  generatePseudo(vunocss: Vunocss) {\n    const {className,pseudo} = vunocss\n    const attrStr = this.generateAttrs(vunocss)\n    return `.${replaceClassName(className)}:${pseudo}{${attrStr}}`\n  }\n  generateAttrs(vunocss: Vunocss) {\n    let attrStr = ''\n    Object.keys(vunocss.attrs).forEach(key => {\n      const value = vunocss.attrs[key]\n      attrStr += `${key}:${value};`\n    })\n\n    return attrStr\n  }\n}\n\nfunction replaceClassName(className: string) {\n\n  return className.replace(/\\:/, '\\\\:')\n}\n\n\n","import { Context } from \"./context\";\nimport { CssGenerator } from \"./generator\";\nimport { VClass } from \"./types\";\n\nexport class Compiler {\n  constructor(public _ctx: Context) {\n    this.patch()\n  }\n  patch() {\n   this.compilerClass()\n  }\n  compilerClass() {\n    const cssGenerator = new CssGenerator(this._ctx)\n\n    \n    this._ctx._classNameSet.forEach(vClass => {\n      \n      this.compilerClassByRuleSting(vClass)\n      this.compilerClassByRuleReg(vClass)\n    })\n    console.log(this._ctx._vunocss);\n\n    cssGenerator.generateCss()\n  }\n  compilerClassByRuleSting(vClass: VClass) {\n    console.log(this._ctx._rulesSting);\n    \n    this._ctx._rulesSting.forEach(rulesSting => {\n      const ruleSting = rulesSting[0]\n      const fnRes = rulesSting[1]()\n      const {name} = vClass\n      if (name === ruleSting) {\n        loadCache(this._ctx, vClass, fnRes)\n      }\n    })\n  }\n  compilerClassByRuleReg(vClass: VClass) {\n    this._ctx._rulesReg.forEach(rulesReg => {\n      const reg = rulesReg[0]\n      const fn = rulesReg[1]\n      const {className, flag, name} = vClass\n      const exec = reg.exec(name)\n      console.log(exec);\n      \n      if (exec) {\n        const fnRes = fn(exec)\n        loadCache(this._ctx, vClass, fnRes)\n      }\n    })\n  }\n}\n\nfunction loadCache(ctx: Context, vClass: VClass, fnRes: any) {\n  const {className, flag, name, pseudo} = vClass\n  let cacheVunocss = ctx._cache.get(className)\n  if (!cacheVunocss) {\n    cacheVunocss = {\n      className,\n      attrs: fnRes,\n      flag,\n      pseudo,\n      name\n    }\n    ctx._cache.set(className, cacheVunocss)\n  }\n  ctx._vunocss.push(cacheVunocss)\n}\n","import type { Presets, PresetsRulesReg, PresetsRulesString, VClass, Vunocss } from \"./types\";\nimport { classReg } from \"./regexps\";\nimport { Compiler } from \"./compiler\";\n\nexport function createContext(presets: Presets[]) {\n  return new Context(presets)\n}\nexport class Context {\n  _presets: Presets[]\n  _rulesSting: PresetsRulesString[] = []\n  _rulesReg: PresetsRulesReg[] = []\n  _classNameSet: Set<VClass> = new Set<VClass>()\n  // _pseudoClassSet: Set<string> = new Set<string>()\n  _vunocss: Vunocss[] = []\n  _cache = new Map<string, Vunocss>()\n  constructor(presets: Presets[]) {\n    this._presets = presets\n    // 初始化正则\n    this.initRules(this._presets)\n  }\n  initRules(presets: Presets[]) {\n    presets.forEach(preset => {\n      preset.rules.forEach(rule => {\n        const flag = rule[0]\n        if (typeof flag === 'string') {\n          this._rulesSting.push(rule as PresetsRulesString)\n        } else if (flag.test) {\n          this._rulesReg.push(rule as PresetsRulesReg)\n        }\n      })\n    })\n  }\n  parseCode(code: string) {\n    this.extractClasses(code)\n    new Compiler(this)\n  }\n  extractClasses(code: string) {\n    while (true) {\n      const exec = classReg.exec(code);\n      if (exec) {\n        const res = exec[1];\n        // todo 伪类\n        res.split(\" \").forEach((it) => {\n          const splitClass = it.split(':')\n          if (splitClass.length>1) {\n            this._classNameSet.add({\n              className: it,\n              flag: 'pseudo',\n              pseudo: splitClass[0],\n              name: splitClass[1]\n            });\n          } else {\n            this._classNameSet.add({\n              className: it,\n              flag: \"class\",\n              name: it\n            });\n          }\n        });\n      } else {\n        break;\n      }\n    }\n    // console.log(this._classNameSet);\n    \n  }\n  reset() {\n    this._vunocss.length = 0\n    this._classNameSet.clear()\n    // this._pseudoClassSet.clear()\n  }\n}\n\n\n","\nconst vueFile = /.vue$/\nexport function filterVue(id: string) {\n  return vueFile.test(id)\n}"],"mappings":"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","names":[]}