{"version":3,"sources":["../src/index.ts","../src/regexps.ts","../src/generator.ts","../src/compiler.ts","../src/context.ts","../src/utils.ts"],"sourcesContent":["import { createContext } from \"./context\"\nimport { PluginOption } from 'vite'\nimport { filterVue } from \"./utils\"\nimport type { MiniunocssParams } from './types'\n\nexport function miniunocss({ presets }: MiniunocssParams) {\n  const context = createContext(presets)\n  return {\n    name: 'miniunocss',\n    enforce: 'pre',\n    transform(code, id) {\n      if (!filterVue(id)) return\n      context.parseCode(code)\n      return null\n    }\n  } as PluginOption\n}\n\n","export const classReg = /class=[\\\"|\\'](.+?)[\\\"|\\']/g;\nexport const brackets = /\\[.+?\\]/\n","import { Context } from \"./context\";\nimport { Flags } from \"./flags\";\nimport { Vunocss } from \"./types\";\n\nexport class CssGenerator {\n  constructor(public _ctx: Context) {\n  }\n  generateCss() {\n    const ctx = this._ctx\n    let css = ''\n    ctx._vunocss.forEach(vunocss => {\n      \n      \n      if (vunocss.flag & Flags.CLASS_PSEUDO) {\n        css += this.generatePseudo(vunocss)\n      } else if (vunocss.flag & Flags.CLASS_STRING) {\n        console.log('vunocss.className', vunocss.className)\n        css += this.generateString(vunocss)\n      }\n    })\n    console.log(css);\n    this._ctx.reset()\n  }\n  generateString(vunocss: Vunocss) {\n    const {className} = vunocss\n    const attrStr = this.generateAttrs(vunocss)\n    return `.${replaceClassName(className)}{${attrStr}}`\n  }\n  generatePseudo(vunocss: Vunocss) {\n    const {className,pseudo} = vunocss\n    const attrStr = this.generateAttrs(vunocss)\n    return `.${replaceClassName(className)}:${pseudo}{${attrStr}}`\n  }\n  generateAttrs(vunocss: Vunocss) {\n    let attrStr = ''\n    Object.keys(vunocss.attrs).forEach(key => {\n      const value = vunocss.attrs[key]\n      attrStr += `${key}:${this.parseAttrValue(value)};`\n    })\n\n    return attrStr\n  }\n  parseAttrValue(value: string) {\n    return isNotUnit(value) ? value : removeBrackets(value)\n  }\n}\n\nfunction replaceClassName(className: string) {\n  return className.replace(/\\:/, '\\\\:').replace(/\\[/, '\\\\[').replace(/\\]/, '\\\\]')\n}\nfunction removeBrackets(str: string) {\n  return str.replace(/\\[/, '').replace(/\\]/, '')\n}\nfunction isNotUnit(str: string) {\n  return !!(parseInt(str[str.length - 1])  + 1)\n}\n\n\n","import { Context } from \"./context\";\nimport { Flags } from \"./flags\";\nimport { CssGenerator } from \"./generator\";\nimport { VClass } from \"./types\";\n\nexport class Compiler {\n  constructor(public _ctx: Context) {\n    this.patch()\n  }\n  patch() {\n   this.compilerClass()\n  }\n  compilerClass() {\n    const cssGenerator = new CssGenerator(this._ctx)\n\n    this._ctx._classNameSet.forEach(vClass => {\n      this.compilerClassByRuleSting(vClass)\n      this.compilerClassByRuleReg(vClass)\n    })\n    cssGenerator.generateCss()\n  }\n  compilerClassByRuleSting(vClass: VClass) {\n    this._ctx._rulesSting.forEach(rulesSting => {\n      const ruleSting = rulesSting[0]\n      const {name, flag} = vClass\n      const fnRes = rulesSting[1](!(flag & Flags.ARBITRARY_VALUE))\n      if (name === ruleSting) {\n        loadCache(this._ctx, vClass, fnRes)\n      }\n    })\n  }\n  compilerClassByRuleReg(vClass: VClass) {\n    this._ctx._rulesReg.forEach(rulesReg => {\n      const reg = rulesReg[0]\n      const fn = rulesReg[1]\n      const { name, flag } = vClass\n      const exec = reg.exec(name)\n      if (exec) {\n        const fnRes = fn(exec, !(flag & Flags.ARBITRARY_VALUE))\n        loadCache(this._ctx, vClass, fnRes)\n      }\n    })\n  }\n}\n\nfunction loadCache(ctx: Context, vClass: VClass, fnRes: any) {\n  const {className, flag, name, pseudo} = vClass\n  let cacheVunocss = ctx._cache.get(className)\n  if (!cacheVunocss) {\n    cacheVunocss = {\n      className,\n      attrs: fnRes,\n      flag,\n      pseudo,\n      name\n    }\n    ctx._cache.set(className, cacheVunocss)\n  }\n  ctx._vunocss.push(cacheVunocss)\n}\n","import type {\n  Presets,\n  PresetsRulesReg,\n  PresetsRulesString,\n  VClass,\n  Vunocss,\n} from \"./types\";\nimport { brackets, classReg } from \"./regexps\";\nimport { Compiler } from \"./compiler\";\nimport { Flags } from \"./flags\";\n\nexport function createContext(presets: Presets[]) {\n  return new Context(presets);\n}\nexport class Context {\n  _presets: Presets[];\n  _rulesSting: PresetsRulesString[] = [];\n  _rulesReg: PresetsRulesReg[] = [];\n  _classNameSet: VClass[] = [];\n  _vunocss: Vunocss[] = [];\n  _cache = new Map<string, Vunocss>();\n  constructor(presets: Presets[]) {\n    this._presets = presets;\n    // 初始化正则\n    this.initRules(this._presets);\n  }\n  initRules(presets: Presets[]) {\n    presets.forEach((preset) => {\n      preset.rules.forEach((rule) => {\n        const flag = rule[0];\n        if (typeof flag === \"string\") {\n          this._rulesSting.push(rule as PresetsRulesString);\n        } else if (flag.test) {\n          this._rulesReg.push(rule as PresetsRulesReg);\n        }\n      });\n    });\n  }\n  parseCode(code: string) {\n    this.extractClasses(code);\n    new Compiler(this);\n  }\n  extractClasses(code: string) {\n    while (true) {\n      const exec = classReg.exec(code);\n      if (exec) {\n        const res = exec[1];\n        // todo 伪类\n        res.split(\" \").forEach((it) => {\n          let res: VClass = {\n            className: it,\n            flag: Flags.DEFAULT,\n          };\n          const splitClass = it.split(\":\");\n          if (splitClass.length > 1) {\n            res.flag |= Flags.CLASS_PSEUDO;\n            res.pseudo = splitClass[0];\n            res.name = splitClass[1];\n          } else {\n            res.flag |= Flags.CLASS_STRING;\n            res.name = it;\n          }\n          this.hasBrackets(res)\n          this.addClassSet(res);\n        });\n      } else {\n        break;\n      }\n    }\n  }\n  reset() {\n    this._vunocss.length = 0;\n    this._classNameSet.length = 0;\n  }\n  hasClassNameSet(vClass: VClass) {\n    return this._classNameSet.some((v) => {\n      return v.className === vClass.className;\n    });\n  }\n  addClassSet(res: VClass) {\n    if (!this.hasClassNameSet(res)) {\n      this._classNameSet.push(res);\n    }\n  }\n  hasBrackets(res: VClass) {\n    if (brackets.test(res.className)) {\n      res.flag |= Flags.ARBITRARY_VALUE;\n    }\n  }\n}\n","\nconst vueFile = /.vue$/\nexport function filterVue(id: string) {\n  return vueFile.test(id)\n}"],"mappings":"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","names":[]}